<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">上映イベント
                    <%= event.name.ja %> の詳細
                </h1>
            </div>
            <!-- /.col -->
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item">
                        <a href="/">Home</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/events/screeningEvent">上映イベント検索</a>
                    </li>
                    <li class="breadcrumb-item active">上映イベント詳細</li>
                </ol>
            </div>
            <!-- /.col -->
        </div>
        <!-- /.row -->
    </div>
    <!-- /.container-fluid -->
</div>
<!-- /.content-header -->

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">

            </div>
            <!-- /.col (RIGHT) -->
        </div>
        <!-- /.row -->

        <div class="row">
            <div class="col-md-8">
                <!-- LINE CHART -->
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">残席数遷移</h3>

                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-widget="collapse">
                                <i class="fa fa-minus"></i>
                            </button>
                            <!-- <button type="button" class="btn btn-tool" data-widget="remove">
                                    <i class="fa fa-times"></i>
                                </button> -->
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart">
                            <canvas id="lineChart" style="height:250px"></canvas>
                        </div>
                    </div>
                    <!-- /.card-body -->
                </div>
                <!-- /.card -->

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fa fa-text-width"></i>
                            Details
                        </h3>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body">
                        <dl>
                            <dt>ID</dt>
                            <dd>
                                <%= event.id %>
                            </dd>
                            <dt>name</dt>
                            <dd>
                                <%= event.superEvent.name.ja %>
                            </dd>
                            <dd>
                                <%= event.superEvent.alternativeHeadline %>
                            </dd>
                            <dd>
                                <%= event.name.ja %>
                            </dd>
                            <dt>作品</dt>
                            <dd>
                                <%= event.workPerformed.name %>
                            </dd>
                            <dd>
                                <%= event.workPerformed.alternativeHeadline %>
                            </dd>
                            <dd>
                                <%= event.workPerformed.duration %>
                            </dd>
                            <dt>場所</dt>
                            <dd>
                                <%= event.superEvent.location.name.ja %>
                            </dd>
                            <dd>
                                <%= event.location.name.ja %>
                            </dd>
                            <dd>
                                <%= event.maximumAttendeeCapacity %>席
                            </dd>
                            <dt>期間</dt>
                            <dd>
                                <%= `${event.startDate}-${event.endDate}` %>
                            </dd>
                        </dl>
                    </div>
                    <!-- /.card-body -->
                </div>
                <!-- /.card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fa fa-text-width"></i>
                            JSON
                        </h3>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body">
                        <div class="form-group">
                            <textarea class="form-control" rows="20" placeholder="" disabled=""><%= JSON.stringify(event, null, '\t') %></textarea>
                        </div>
                    </div>
                    <!-- /.card-body -->
                </div>
                <!-- /.card -->
            </div>
            <!-- ./col -->
            <div class="col-md-4">
                <!-- TABLE: LATEST ORDERS -->
                <div class="card">
                    <div class="card-header border-transparent">
                        <h3 class="card-title">注文履歴</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-widget="collapse">
                                <i class="fa fa-minus"></i>
                            </button>
                            <!-- <button type="button" class="btn btn-tool" data-widget="remove">
                                    <i class="fa fa-times"></i>
                                </button> -->
                        </div>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table m-0" id="orders">
                                <thead>
                                    <tr>
                                        <th>Order Number</th>
                                        <th>Order Date</th>
                                        <th>Item</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <!-- /.table-responsive -->
                    </div>
                    <!-- /.card-body -->
                    <div class="card-footer clearfix">
                        <!-- <a href="javascript:void(0)" class="btn btn-sm btn-info float-left">Place New Order</a>
                            <a href="javascript:void(0)" class="btn btn-sm btn-secondary float-right">View All Orders</a> -->
                    </div>
                    <!-- /.card-footer -->
                </div>
                <!-- /.card -->
            </div>
            <!-- ./col -->
        </div>
        <!-- /.row -->

        <div class="row">
            <div class="col-md-6">
            </div>
        </div>
        <!-- /.row -->
    </div>
    <!-- /.container-fluid -->
</section>
<!-- /.content -->

<!-- DataTables -->
<link rel="stylesheet" href="/node_modules/admin-lte/plugins/datatables/dataTables.bootstrap4.css">
<!-- ChartJS 1.0.1 -->
<script src="/node_modules/admin-lte/plugins/chart.js/Chart.min.js"></script>

<%
const eventJson = JSON.stringify(event).replace(/"/g, '\\\"');
%>
    <!-- page script -->
    <script>
        var event = JSON.parse("<%- eventJson %>");
        var orders = [];
        var searchedAllOrders = false;
        var limit = 100;
        var page = 0;
        var lineChart;
        $(function () {
            // 注文検索
            console.log('searching orders...', page);
            searchOrders(function () {
                console.log('creating line chart...');
                createLineChart();
            });
        });
        function searchOrders(cb) {
            page += 1;
            $.getJSON(
                '/events/screeningEvent/' + event.id + '/orders',
                { limit: limit, page: page }
            ).done(function (data) {
                searchedAllOrders = (data.data.length < limit);
                $.each(data.data, function (key, order) {
                    orders.push(order);
                    let badge = 'badge-info';
                    switch (order.orderStatus) {
                        case 'OrderDelivered':
                            badge = 'badge-danger';
                            break;
                        default:
                    }
                    $('<tr>').html(
                        '<td>' + '<a target="_blank" href="/orders/' + order.orderNumber + '">' + order.orderNumber + '</a>' + '</td>'
                        + '<td>' + order.orderDate + '</td>'
                        + '<td>' + order.acceptedOffers.map((o) => o.itemOffered.reservedTicket.ticketedSeat.seatNumber).join(',') + '</td>'
                        + '<td>' + '<span class="badge ' + badge + '">' + order.orderStatus + '</span>' + '</td>'
                    ).appendTo("#orders tbody");
                });
                if (!searchedAllOrders) {
                    searchOrders(cb);
                } else {
                    cb();
                }
            }).fail(function () {
                alert('注文履歴を取得できませんでした')
            });
        }
        function createLineChart() {
            // 全座席数は
            var numberOfSeats = event.maximumAttendeeCapacity;
            // 売り出し日時は？
            var reservationStartDate = moment(event.startDate).add(-3, 'days').toDate();
            // 予約期間
            var reservationPeriodInMinutes = moment(event.endDate).diff(moment(reservationStartDate), 'hours');
            /**
             * ラインチャート作成
             */
            var data = orders.reduce(
                (a, b) => {
                    numberOfSeats -= b.acceptedOffers.length;
                    // 予約開始からの時間
                    const diff = moment(b.orderDate).diff(moment(reservationStartDate), 'hours', true);
                    a.push({
                        x: diff,
                        y: numberOfSeats,
                    });

                    return a;
                },
                [{ x: 0, y: numberOfSeats }],
            );
            var areaChartData = {
                // labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
                labels: [],
                datasets: [
                    {
                        label: 'Orders',
                        // backgroundColor: 'rgba(0, 123, 255, 0.9)',
                        data: data
                    },
                ]
            }
            //-------------
            //- LINE CHART -
            //--------------
            var lineChartCanvas = $('#lineChart').get(0).getContext('2d');
            var lineChartOptions = {
                //Boolean - If we should show the scale at all
                showScale: true,
                //Boolean - Whether grid lines are shown across the chart
                scaleShowGridLines: false,
                //String - Colour of the grid lines
                scaleGridLineColor: 'rgba(0,0,0,.05)',
                //Number - Width of the grid lines
                scaleGridLineWidth: 1,
                //Boolean - Whether to show horizontal lines (except X axis)
                scaleShowHorizontalLines: true,
                //Boolean - Whether to show vertical lines (except Y axis)
                scaleShowVerticalLines: true,
                //Boolean - Whether the line is curved between points
                bezierCurve: false,
                //Number - Tension of the bezier curve between points
                bezierCurveTension: 0.3,
                //Boolean - Whether to show a dot for each point
                pointDot: true,
                //Number - Radius of each point dot in pixels
                pointDotRadius: 4,
                //Number - Pixel width of point dot stroke
                pointDotStrokeWidth: 1,
                //Number - amount extra to add to the radius to cater for hit detection outside the drawn point
                pointHitDetectionRadius: 20,
                //Boolean - Whether to show a stroke for datasets
                datasetStroke: true,
                //Number - Pixel width of dataset stroke
                datasetStrokeWidth: 2,
                //Boolean - Whether to fill the dataset with a color
                datasetFill: false,
                //String - A legend template
                legendTemplate: '',
                //Boolean - whether to maintain the starting aspect ratio or not when responsive, if set to false, will take up entire container
                maintainAspectRatio: true,
                //Boolean - whether to make the chart responsive to window resizing
                responsive: true,
                legend: {
                    position: 'bottom',
                    labels: {
                        // fontColor: '#fff',
                    },
                },
                scales: {
                    xAxes: [
                        {
                            type: 'linear',
                            position: 'bottom',
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: '販売開始からの経過時間(hours)',
                            },
                            gridLines: {
                                display: true,
                                // color: Chart.axisLineColor,
                            },
                            ticks: {
                                // fontColor: Chart.textColor,
                                beginAtZero: true,
                                min: 0,
                                max: reservationPeriodInMinutes,
                                // stepSize: 100,
                            },
                        },
                    ],
                    yAxes: [
                        {
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: '残席数',
                            },
                            gridLines: {
                                display: true,
                                // color: Chart.axisLineColor,
                            },
                            ticks: {
                                // fontColor: Chart.textColor,
                                beginAtZero: true,
                                min: 0,
                            },
                        },
                    ],
                }
            };
            lineChart = new Chart(lineChartCanvas, {
                type: 'line',
                data: areaChartData,
                options: lineChartOptions
            });
        }
    </script>